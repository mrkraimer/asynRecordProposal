<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Proposal: Asynchronous PVRecord &#8212; Proposal For asynchronous PVRecord .1 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Welcome to Proposal For asynchronous PVRecord’s documentation!" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="index.html" title="Welcome to Proposal For asynchronous PVRecord’s documentation!"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Proposal For asynchronous PVRecord .1 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="proposal-asynchronous-pvrecord">
<h1>Proposal: Asynchronous PVRecord<a class="headerlink" href="#proposal-asynchronous-pvrecord" title="Permalink to this headline">¶</a></h1>
<p><strong>Author:</strong> Marty Kraimer</p>
<p><strong>Date:</strong> 2017.05.25</p>
<div class="section" id="proposal-summary">
<h2>Proposal Summary<a class="headerlink" href="#proposal-summary" title="Permalink to this headline">¶</a></h2>
<p>Currently the only process method for PVRecord is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">process</span><span class="p">();</span>
</pre></div>
</div>
<p>This method does not return until it is done. Thus it is a synchronous method.</p>
<p>This proposal adds the following methods:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">boolean</span> <span class="n">isAsynRecord</span><span class="p">();</span>
<span class="n">void</span> <span class="n">process</span><span class="p">(</span>                         <span class="o">//</span> <span class="n">For</span> <span class="n">ChannelProcess</span>
   <span class="n">ChannelProcess</span> <span class="n">channelProcess</span><span class="p">,</span>
   <span class="n">ChannelProcessRequester</span> <span class="n">channelProcessRequester</span><span class="p">,</span>
   <span class="n">boolean</span> <span class="n">block</span><span class="p">);</span>
<span class="n">void</span> <span class="n">PVRecord</span><span class="p">::</span><span class="n">process</span><span class="p">(</span>               <span class="o">//</span> <span class="n">For</span> <span class="n">ChannelGet</span>
   <span class="n">ChannelGet</span> <span class="n">channelGet</span><span class="p">,</span>
   <span class="n">ChannelGetRequester</span> <span class="n">channelGetRequester</span><span class="p">,</span>
   <span class="n">boolean</span> <span class="n">block</span><span class="p">,</span>
   <span class="n">PVCopy</span> <span class="n">pvCopy</span><span class="p">,</span>
   <span class="n">PVStructure</span> <span class="n">pvData</span><span class="p">,</span>
   <span class="n">BitSet</span> <span class="n">bitSet</span><span class="p">);</span>
<span class="n">void</span> <span class="n">process</span><span class="p">(</span>                         <span class="o">//</span> <span class="n">For</span> <span class="n">ChannelPut</span>
   <span class="n">ChannelPut</span> <span class="n">channelPut</span><span class="p">,</span>
   <span class="n">ChannelPutRequester</span> <span class="n">channelPutRequester</span><span class="p">,</span>
   <span class="n">boolean</span> <span class="n">block</span><span class="p">,</span>
   <span class="n">PVCopy</span> <span class="n">pvCopy</span><span class="p">,</span>
   <span class="n">PVStructure</span> <span class="n">pvData</span><span class="p">,</span>
   <span class="n">BitSet</span> <span class="n">bitSet</span><span class="p">);</span>
<span class="n">void</span> <span class="n">process</span><span class="p">(</span>                         <span class="o">//</span> <span class="n">For</span> <span class="n">ChannelPutGet</span>
   <span class="n">ChannelPutGet</span> <span class="n">channelPutGet</span><span class="p">,</span>
   <span class="n">ChannelPutGetRequester</span> <span class="n">channelPutGetRequester</span><span class="p">,</span>
   <span class="n">boolean</span> <span class="n">block</span><span class="p">,</span>
   <span class="n">PVCopy</span> <span class="n">pvPutCopy</span><span class="p">,</span>
   <span class="n">PVStructure</span> <span class="n">pvPutStructure</span><span class="p">,</span>
   <span class="n">BitSet</span> <span class="n">putBitSet</span><span class="p">,</span>
   <span class="n">PVCopy</span> <span class="n">pvGetCopy</span><span class="p">,</span>
   <span class="n">PVStructure</span> <span class="n">pvGetStructure</span><span class="p">,</span>
   <span class="n">BitSet</span> <span class="n">getBitSet</span><span class="p">);</span>
</pre></div>
</div>
<p>PVRecord is a base class.
It implements <strong>isAsynRecord</strong> by always returning false.
It implements the other new methods by always calling the requester with a status that indicates
failure.</p>
<p>Code can extend PVRecord and implement any of the above methods desired.</p>
<p>The rest of this documemt provides material that attempts to explain the proposal in more detail.</p>
</div>
<div class="section" id="epics-v4-background">
<h2>EPICS V4 Background<a class="headerlink" href="#epics-v4-background" title="Permalink to this headline">¶</a></h2>
<p>This is a brief summary EPICS V4.
It only discusses the EPICS V4 components required to understand this proposal.</p>
<p>A more complete introduction to EPICS V4 is provided in:</p>
<p>&lt;<a class="reference external" href="http://epics-pvdata.sourceforge.net/informative/developerGuide/developerGuide.html">http://epics-pvdata.sourceforge.net/informative/developerGuide/developerGuide.html</a>&gt;</p>
<p>This background is intended for readers that have at least some knowlege of object oriented languages. In particular Java or C++. The syntax in this proposal is
psuedo code similar to Java but simplified.</p>
<p>EPICS V4 has a number of modules.
Most are implemented in both Java and C++.
In order to understand this proposal, some knowledge of the modules
<strong>pvData</strong>, <strong>pvAccess</strong>, and <strong>pvDatabase</strong> is required.
The following discussion applies to both the Java and C++ implementation of each module.</p>
<p><strong>pvData</strong> provides a way to define and access structured data.</p>
<p><strong>pvAccess</strong> provides communication between a client and a server. This includes network suport.
All data is passed as <strong>pvData</strong> structures.</p>
<p><strong>pvDatabase</strong> provides a way to create PVRecords. A PVRecord holds a memory resident <strong>pvData</strong>
structure. In addition <strong>pvDatabase</strong> provides a <strong>pvAccess</strong> provider that allows a client to access the PVRecords.</p>
<div class="section" id="pvdata">
<h3>pvData<a class="headerlink" href="#pvdata" title="Permalink to this headline">¶</a></h3>
<p>The following are the <strong>pvData</strong> components of interest to this proposal.</p>
<div class="section" id="pvdata-pvstructure">
<h4>pvData: PVStructure<a class="headerlink" href="#pvdata-pvstructure" title="Permalink to this headline">¶</a></h4>
<p>A <strong>PVStructure</strong> instance holds a set of structured data.</p>
<p>The following code:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">FieldCreate</span> <span class="n">fieldCreate</span> <span class="o">=</span> <span class="n">FieldFactory</span><span class="o">.</span><span class="n">getFieldCreate</span><span class="p">();</span>
<span class="n">FieldBuilder</span> <span class="n">fb</span> <span class="o">=</span> <span class="n">fieldCreate</span><span class="o">.</span><span class="n">createFieldBuilder</span><span class="p">();</span>
<span class="n">StandardField</span> <span class="n">standardField</span> <span class="o">=</span> <span class="n">StandardFieldFactory</span><span class="o">.</span><span class="n">getStandardField</span><span class="p">();</span>
<span class="n">Structure</span> <span class="n">structure</span> <span class="o">=</span>
        <span class="n">fb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">ScalarType</span><span class="o">.</span><span class="n">pvDouble</span><span class="p">)</span><span class="o">.</span>
        <span class="n">add</span><span class="p">(</span><span class="s2">&quot;alarm&quot;</span><span class="p">,</span><span class="n">standardField</span><span class="o">.</span><span class="n">alarm</span><span class="p">())</span><span class="o">.</span>
        <span class="n">add</span><span class="p">(</span><span class="s2">&quot;timeStamp&quot;</span><span class="p">,</span><span class="n">standardField</span><span class="o">.</span><span class="n">timeStamp</span><span class="p">())</span><span class="o">.</span>
        <span class="n">createStructure</span><span class="p">();</span>
<span class="n">PVStructure</span> <span class="n">pvStructure</span> <span class="o">=</span> <span class="n">pvDataCreate</span><span class="o">.</span><span class="n">createPVStructure</span><span class="p">(</span><span class="n">structure</span><span class="p">);</span>
<span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">pvStructure</span><span class="p">);</span>
</pre></div>
</div>
<p>produces:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">structure</span>
    <span class="n">double</span> <span class="n">value</span> <span class="mi">0</span>
    <span class="n">alarm_t</span> <span class="n">alarm</span>
        <span class="nb">int</span> <span class="n">severity</span> <span class="mi">0</span>
        <span class="nb">int</span> <span class="n">status</span> <span class="mi">0</span>
        <span class="n">string</span> <span class="n">message</span>
    <span class="n">time_t</span> <span class="n">timeStamp</span>
        <span class="n">long</span> <span class="n">secondsPastEpoch</span> <span class="mi">0</span>
        <span class="nb">int</span> <span class="n">nanoseconds</span> <span class="mi">0</span>
        <span class="nb">int</span> <span class="n">userTag</span> <span class="mi">0</span>
</pre></div>
</div>
<p>In this proposal many of the arguments are a PVStructure.</p>
<p>For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">someMethod</span><span class="p">(</span>
   <span class="o">...</span>
   <span class="n">PVStructure</span> <span class="n">pvData</span><span class="p">,</span>    <span class="o">//</span> <span class="n">PVStructure</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">a</span> <span class="n">structure</span><span class="o">.</span>
   <span class="o">...</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="pvdata-bitset">
<h4>pvData: BitSet<a class="headerlink" href="#pvdata-bitset" title="Permalink to this headline">¶</a></h4>
<p><strong>pvData</strong> provides an API and implementation for a bitSet that can be associated with
a top level PVStructure.
The bitSet assigns a bit to each field of the PVStructure.</p>
</div>
<div class="section" id="pvdata-pvcopy">
<h4>pvData: PVCopy<a class="headerlink" href="#pvdata-pvcopy" title="Permalink to this headline">¶</a></h4>
<p><strong>pvData</strong> also provides an API and implementation for a facility named <strong>pvCopy</strong>.
An instance of <strong>pvCopy</strong> accesses a subset of the fields in a top level PVStructure
and also allows options to be associated with each field in the subset.</p>
</div>
</div>
<div class="section" id="pvaccess">
<h3>pvAccess<a class="headerlink" href="#pvaccess" title="Permalink to this headline">¶</a></h3>
<p><strong>pvAccess</strong> provides both client and server support for passing <strong>pvData</strong> objects between client and server.</p>
<p>Any data source that holds data as <strong>pvData</strong> objects can also implement a <strong>ChannelProvider</strong>,
and register the provider with <strong>pvAccess</strong>.
It is then a server.
A provider can provide access to an arbitrary number of objects but
each object must have a unique channelName and a top level <strong>PVStructure</strong>.</p>
<p>A client connects to a provider by asking to connect to a channelName.
The provider returns a <strong>Channel</strong> object to the client.</p>
<p>Of interest to this proposal are the following <strong>Channel</strong> methods:</p>
<p><strong>createChannelProcess</strong></p>
<blockquote>
<div>A <strong>ChannelProcess</strong> provides a method that allows the client to ask that the server process.</div></blockquote>
<p><strong>createChannelGet</strong></p>
<blockquote>
<div>A <strong>ChannelGet</strong> provides methods that allow the client to get a subset of the data in
the top level <strong>PVStructure</strong> for the channel.</div></blockquote>
<p><strong>createChannelPut</strong></p>
<blockquote>
<div>A <strong>ChannelPut</strong> provides methods that allow the client to put to a subset of the data in
the top level <strong>PVStructure</strong> for the channel.</div></blockquote>
<p><strong>createChannelPutGet</strong></p>
<blockquote>
<div>A <strong>ChannelPutGet</strong> provides methods that allow the client to put to a subset of the data in
the top level <strong>PVStructure</strong> for the channel. Then the record is normally processed.
Finally a different subset of the data in
the top level <strong>PVStructure</strong> is returned to the client.</div></blockquote>
<p>The <strong>pvAccess</strong> API is callback based.
Thus associated with many client requests is a client supplied callback.
As a simple example consider <strong>ChannelProcess</strong>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Channel</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="n">ChannelProcess</span> <span class="n">createChannelProcess</span><span class="p">(</span>
        <span class="n">ChannelProcessRequester</span> <span class="n">channelProcessRequester</span><span class="p">,</span>
            <span class="n">PVStructure</span> <span class="n">pvRequest</span><span class="p">);</span>
    <span class="o">...</span>
 <span class="p">}</span>
 <span class="k">class</span> <span class="nc">ChannelProcessRequester</span><span class="p">{</span>
     <span class="n">void</span> <span class="n">channelProcessConnect</span><span class="p">(</span><span class="n">Status</span> <span class="n">status</span><span class="p">,</span> <span class="n">ChannelProcess</span> <span class="n">channelProcess</span><span class="p">);</span>
     <span class="n">void</span> <span class="n">processDone</span><span class="p">(</span><span class="n">Status</span> <span class="n">status</span><span class="p">,</span> <span class="n">ChannelProcess</span> <span class="n">channelProcess</span><span class="p">);</span>
 <span class="p">}</span>
 <span class="k">class</span> <span class="nc">ChannelProcess</span> <span class="p">{</span>
     <span class="n">void</span> <span class="n">process</span><span class="p">();</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>When the client calls <strong>ChannelProcess::process</strong>, the method issues the request and returns immediately.
When the process request completes <strong>ChannelProcessRequester::processDone</strong> is called.</p>
<p>The same pattern occurs for <strong>ChannelGet</strong>, <strong>ChannelPut</strong>, and <strong>ChannelPutGet</strong>.</p>
</div>
<div class="section" id="pvdatabase">
<h3>pvDatabase<a class="headerlink" href="#pvdatabase" title="Permalink to this headline">¶</a></h3>
<p><strong>pvDatabase</strong> is one of the EPICS V4 modules.</p>
<p>It provides two main features:</p>
<p><strong>PVDatabase</strong></p>
<blockquote>
<div>This is a memory resident database of <strong>PVRecord</strong> instances.
Each record has data composed a top level <strong>PVStructure</strong>.
A base class that is a complete implemention of <strong>PVRecord</strong> is provided.
Other code can be provided that extends the base class.</div></blockquote>
<p><strong>ChannelProviderLocal</strong></p>
<blockquote>
<div>This is a channel provider for accessing <strong>PVRecord</strong> instances.
Of interest to this proposal is that it implements <strong>ChannelProcess</strong>,
<strong>ChannelGet</strong>, <strong>ChannelPut</strong>, and <strong>ChannelPutGet</strong>.</div></blockquote>
</div>
<div class="section" id="pvrecord-processing">
<h3>PVRecord processing<a class="headerlink" href="#pvrecord-processing" title="Permalink to this headline">¶</a></h3>
<p>Currently the only process method for PVRecord is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">PVRecord</span><span class="p">::</span><span class="n">process</span><span class="p">();</span>
</pre></div>
</div>
<p>This method does not return until it is done,
i. e. it is a synchronous method.</p>
<p>What process does is determined by the support code attached to the record instance.
It can be an action that completes quickly or may take a long time to complete.</p>
<p>This method is called by <strong>ChannelProviderLocal</strong>.
It is called by the implementation of <strong>ChannelProcsss</strong>, <strong>ChannelGet</strong>, <strong>ChannelPut</strong>, and <strong>ChannelPutGet</strong>.</p>
<p>This proposal specifies additional process methods that support asynchronous record processing.
It is up to the support code to decide if it should be a synchronous or asynchronous record.</p>
</div>
<div class="section" id="synchronous-processing">
<h3>Synchronous Processing<a class="headerlink" href="#synchronous-processing" title="Permalink to this headline">¶</a></h3>
<p>The following makes a record synchronous.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">boolean</span> <span class="n">PVRecord</span><span class="p">::</span><span class="n">isAsynRecord</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">false</span><span class="p">;}</span>
<span class="n">void</span> <span class="n">process</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="asynchronous-processing">
<h3>Asynchronous Processing<a class="headerlink" href="#asynchronous-processing" title="Permalink to this headline">¶</a></h3>
<p>The following method makes a record asynchronous.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">boolean</span> <span class="n">PVRecord</span><span class="p">::</span><span class="n">isAsynRecord</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">true</span><span class="p">;}</span>
</pre></div>
</div>
<div class="section" id="channelprocess">
<h4>ChannelProcess<a class="headerlink" href="#channelprocess" title="Permalink to this headline">¶</a></h4>
<p id="index-0">The following is the method for channelProcess:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">PVRecord</span><span class="p">::</span><span class="n">process</span><span class="p">(</span>
   <span class="n">ChannelProcess</span> <span class="n">channelProcess</span><span class="p">,</span>
   <span class="n">ChannelProcessRequester</span> <span class="n">channelProcessRequester</span><span class="p">,</span>
   <span class="n">boolean</span> <span class="n">block</span><span class="p">);</span>
</pre></div>
</div>
<p>where</p>
<dl class="docutils">
<dt>channelProcess</dt>
<dd>The ChannelProcess instance that is issuing the process request.</dd>
<dt>channelProcessRequester</dt>
<dd>The ChannelProcessRequester instance that called channelProcess.</dd>
<dt>block</dt>
<dd><p class="first"><em>true</em> means to call the requester only after process completes.</p>
<p class="last"><em>false</em> means to call the requester immediately.</p>
</dd>
</dl>
<p>The implementation of <strong>ChannelProviderLocal::ChannelProcess</strong> calls this as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">process</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pvRecord</span><span class="o">.</span><span class="n">isAsynRecord</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="n">channelProcessRequester</span><span class="p">,</span><span class="n">block</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pvRecord</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">beginGroupPut</span><span class="p">();</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">process</span><span class="p">();</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">endGroupPut</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">channelProcessRequester</span><span class="o">.</span><span class="n">processDone</span><span class="p">(</span><span class="n">okStatus</span><span class="p">,</span><span class="n">this</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="channelget">
<h4>ChannelGet<a class="headerlink" href="#channelget" title="Permalink to this headline">¶</a></h4>
<p id="index-1">The following is the method for channelGet:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">PVRecord</span><span class="p">::</span><span class="n">process</span><span class="p">(</span>
   <span class="n">ChannelGet</span> <span class="n">channelGet</span><span class="p">,</span>
   <span class="n">ChannelGetRequester</span> <span class="n">channelGetRequester</span><span class="p">,</span>
   <span class="n">boolean</span> <span class="n">block</span><span class="p">,</span>
   <span class="n">PVCopy</span> <span class="n">pvCopy</span><span class="p">,</span>
   <span class="n">PVStructure</span> <span class="n">pvData</span><span class="p">,</span>
   <span class="n">BitSet</span> <span class="n">bitSet</span><span class="p">);</span>
</pre></div>
</div>
<p>where</p>
<dl class="docutils">
<dt>channelGet</dt>
<dd>The ChannelGet instance that is issuing the process request.</dd>
<dt>channelGetRequester</dt>
<dd>The ChannelGetRequester instance that called channelGet.</dd>
<dt>block</dt>
<dd><p class="first"><em>true</em> means to call the requester only after process completes.</p>
<p class="last"><em>false</em> means to call the requester immediately.</p>
</dd>
<dt>pvCopy</dt>
<dd>The PVCopy instance for the client.</dd>
<dt>pvData</dt>
<dd>The client PVStructure.</dd>
<dt>bitSet</dt>
<dd>The BitSet that shows any data changes made to pvData since the last get request..</dd>
</dl>
<p>The implementation of <strong>ChannelProviderLocal::ChannelGet</strong> calls this as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">get</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pvRecord</span><span class="o">.</span><span class="n">isAsynRecord</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">callProcess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="n">channelGetRequester</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">pvCopy</span><span class="p">,</span><span class="n">pvStructure</span><span class="p">,</span><span class="n">bitSet</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">bitSet</span><span class="o">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">pvRecord</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">callProcess</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pvRecord</span><span class="o">.</span><span class="n">beginGroupPut</span><span class="p">();</span>
            <span class="n">pvRecord</span><span class="o">.</span><span class="n">process</span><span class="p">();</span>
            <span class="n">pvRecord</span><span class="o">.</span><span class="n">endGroupPut</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">pvCopy</span><span class="o">.</span><span class="n">updateCopySetBitSet</span><span class="p">(</span><span class="n">pvStructure</span><span class="p">,</span> <span class="n">bitSet</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">firstTime</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bitSet</span><span class="o">.</span><span class="n">clear</span><span class="p">();</span>
        <span class="n">bitSet</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">firstTime</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">channelGetRequester</span><span class="o">.</span><span class="n">getDone</span><span class="p">(</span><span class="n">okStatus</span><span class="p">,</span><span class="n">this</span><span class="p">,</span><span class="n">pvStructure</span><span class="p">,</span><span class="n">bitSet</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="channelput">
<h4>ChannelPut<a class="headerlink" href="#channelput" title="Permalink to this headline">¶</a></h4>
<p id="index-2">The following is the method for channelPut:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">PVRecord</span><span class="p">::</span><span class="n">process</span><span class="p">(</span>
   <span class="n">ChannelPut</span> <span class="n">channelPut</span><span class="p">,</span>
   <span class="n">ChannelPutRequester</span> <span class="n">channelPutRequester</span><span class="p">,</span>
   <span class="n">boolean</span> <span class="n">block</span><span class="p">,</span>
   <span class="n">PVCopy</span> <span class="n">pvCopy</span><span class="p">,</span>
   <span class="n">PVStructure</span> <span class="n">pvData</span><span class="p">,</span>
   <span class="n">BitSet</span> <span class="n">bitSet</span><span class="p">);</span>
</pre></div>
</div>
<p>where</p>
<dl class="docutils">
<dt>channelPut</dt>
<dd>The ChannelPut that is issuing the process request.</dd>
<dt>channelPutRequester</dt>
<dd>The ChannelPutRequester that called channelPut.</dd>
<dt>block</dt>
<dd><p class="first"><em>true</em> means to call the requester only after process completes.</p>
<p class="last"><em>false</em> means to call the requester immediately.</p>
</dd>
<dt>pvCopy</dt>
<dd>The PVCopy instance for the client.</dd>
<dt>pvData</dt>
<dd>The client PVStructure</dd>
<dt>bitSet</dt>
<dd>The BitSet that shows changes the client made to pvData.</dd>
</dl>
<p>The implementation of <strong>ChannelProviderLocal::ChannelPut</strong> calls this as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">put</span><span class="p">(</span><span class="n">PVStructure</span> <span class="n">pvPutStructure</span><span class="p">,</span> <span class="n">BitSet</span> <span class="n">bitSet</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">isDestroyed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">channelPutRequester</span><span class="o">.</span><span class="n">putDone</span><span class="p">(</span><span class="n">requestDestroyedStatus</span><span class="p">,</span><span class="n">this</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pvRecord</span><span class="o">.</span><span class="n">isAsynRecord</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">callProcess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="n">channelPutRequester</span><span class="p">,</span><span class="n">block</span><span class="p">,</span><span class="n">pvCopy</span><span class="p">,</span><span class="n">pvPutStructure</span><span class="p">,</span><span class="n">bitSet</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pvRecord</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">beginGroupPut</span><span class="p">();</span>
        <span class="n">pvCopy</span><span class="o">.</span><span class="n">updateMaster</span><span class="p">(</span><span class="n">pvPutStructure</span><span class="p">,</span><span class="n">bitSet</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">callProcess</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pvRecord</span><span class="o">.</span><span class="n">process</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">endGroupPut</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pvRecord</span><span class="o">.</span><span class="n">getTraceLevel</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;ChannelPutLocal::put recordName &quot;</span> <span class="o">+</span> <span class="n">pvRecord</span><span class="o">.</span><span class="n">getRecordName</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="n">channelPutRequester</span><span class="o">.</span><span class="n">putDone</span><span class="p">(</span><span class="n">okStatus</span><span class="p">,</span><span class="n">this</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="channelputget">
<h4>ChannelPutGet<a class="headerlink" href="#channelputget" title="Permalink to this headline">¶</a></h4>
<p id="index-3">The following is the method for channelPutGet:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">PVRecord</span><span class="p">::</span><span class="n">process</span><span class="p">(</span>
   <span class="n">ChannelPutGet</span> <span class="n">channelPutGet</span><span class="p">,</span>
   <span class="n">ChannelPutGetRequester</span> <span class="n">channelPutGetRequester</span><span class="p">,</span>
   <span class="n">boolean</span> <span class="n">block</span><span class="p">,</span>
   <span class="n">PVCopy</span> <span class="n">pvPutCopy</span><span class="p">,</span>
   <span class="n">PVStructure</span> <span class="n">pvPutStructure</span><span class="p">,</span>
   <span class="n">BitSet</span> <span class="n">putBitSet</span><span class="p">,</span>
   <span class="n">PVCopy</span> <span class="n">pvGetCopy</span><span class="p">,</span>
   <span class="n">PVStructure</span> <span class="n">pvGetStructure</span><span class="p">,</span>
   <span class="n">BitSet</span> <span class="n">getBitSet</span><span class="p">);</span>
</pre></div>
</div>
<p>where</p>
<dl class="docutils">
<dt>channelPutGet</dt>
<dd>The ChannelPutGet that is issuing the process request.</dd>
<dt>channelPutGetRequester</dt>
<dd>The ChannelPutGetRequester that called channelPutGet.</dd>
<dt>block</dt>
<dd><p class="first"><em>true</em> means to call the requester only after process completes.</p>
<p class="last"><em>false</em> means to call the requester immediately.</p>
</dd>
<dt>pvPutCopy</dt>
<dd>The PVCopy instance for the pvPutStructure.</dd>
<dt>pvPutStructure</dt>
<dd>The data the client sent.</dd>
<dt>putBitSet</dt>
<dd>The BitSet that shows data changes the client made to pvPutStructure.</dd>
<dt>pvGetCopy</dt>
<dd>The PVCopy instance for the pvGetStructure.</dd>
<dt>pvGetStructure</dt>
<dd>The data returned to the client.</dd>
<dt>getBitSet</dt>
<dd>The BitSet that shows any data changes made to pvGetStructure since the last putGet request.</dd>
</dl>
<p>The implementation of <strong>ChannelProviderLocal::ChannelPutGet</strong> calls this as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">putGet</span><span class="p">(</span><span class="n">PVStructure</span> <span class="n">pvPutStructure</span><span class="p">,</span> <span class="n">BitSet</span> <span class="n">putBitSet</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">isDestroyed</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">channelPutGetRequester</span><span class="o">.</span><span class="n">putGetDone</span><span class="p">(</span><span class="n">requestDestroyedStatus</span><span class="p">,</span><span class="n">this</span><span class="p">,</span><span class="n">null</span><span class="p">,</span><span class="n">null</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pvRecord</span><span class="o">.</span><span class="n">isAsynRecord</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">callProcess</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="n">channelPutGetRequester</span><span class="p">,</span><span class="n">block</span><span class="p">,</span>
                <span class="n">pvPutCopy</span><span class="p">,</span><span class="n">pvPutStructure</span><span class="p">,</span><span class="n">putBitSet</span><span class="p">,</span>
                <span class="n">pvGetCopy</span><span class="p">,</span><span class="n">pvGetStructure</span><span class="p">,</span><span class="n">getBitSet</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pvRecord</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">beginGroupPut</span><span class="p">();</span>
        <span class="n">pvPutCopy</span><span class="o">.</span><span class="n">updateMaster</span><span class="p">(</span><span class="n">pvPutStructure</span><span class="p">,</span> <span class="n">putBitSet</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">callProcess</span><span class="p">)</span> <span class="n">pvRecord</span><span class="o">.</span><span class="n">process</span><span class="p">();</span>
        <span class="n">getBitSet</span><span class="o">.</span><span class="n">clear</span><span class="p">();</span>
        <span class="n">pvGetCopy</span><span class="o">.</span><span class="n">updateCopySetBitSet</span><span class="p">(</span><span class="n">pvGetStructure</span><span class="p">,</span> <span class="n">getBitSet</span><span class="p">);</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">endGroupPut</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="n">pvRecord</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pvRecord</span><span class="o">.</span><span class="n">getTraceLevel</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;ChannelPutGetLocal::putGet recordName &quot;</span> <span class="o">+</span> <span class="n">pvRecord</span><span class="o">.</span><span class="n">getRecordName</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="n">channelPutGetRequester</span><span class="o">.</span><span class="n">putGetDone</span><span class="p">(</span><span class="n">okStatus</span><span class="p">,</span><span class="n">this</span><span class="p">,</span><span class="n">pvGetStructure</span><span class="p">,</span><span class="n">getBitSet</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pvcopy-record-options">
<h3>PVCopy: record options<a class="headerlink" href="#pvcopy-record-options" title="Permalink to this headline">¶</a></h3>
<div class="section" id="block">
<h4>block<a class="headerlink" href="#block" title="Permalink to this headline">¶</a></h4>
<p>This is used for a channel request that results in the provider issung a
process request.
It specifies if a request should block until processing completes .</p>
<p>For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">pvput</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;record[block=true]field(value)&quot;</span> <span class="n">someAsynChannel</span> <span class="n">Acquire</span>
</pre></div>
</div>
<p>This option is honored by the following:</p>
<dl class="docutils">
<dt>pvDatabase</dt>
<dd>For channelProcess, channelGet, channelPut, and channelPutGet.
<strong>Note:</strong> Only if this proposal is accepted and implemented.</dd>
<dt>pvaSrv</dt>
<dd>For channelProcess, channelGet, and channelPut</dd>
</dl>
</div>
</div>
<div class="section" id="example-busy-record">
<h3>Example: Busy Record<a class="headerlink" href="#example-busy-record" title="Permalink to this headline">¶</a></h3>
<p>The example busy record is available at:</p>
<p>&lt;<a class="reference external" href="https://github.com/mrkraimer/exampleJava/blob/master/database/src/org/epics/exampleJava/exampleDatabase/ExampleBusyRecord.java">https://github.com/mrkraimer/exampleJava/blob/master/database/src/org/epics/exampleJava/exampleDatabase/ExampleBusyRecord.java</a>&gt;</p>
<p>The example allows a client to set the record busy and wait until the record is done.</p>
<p>For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">pvput</span> <span class="o">-</span><span class="n">r</span> <span class="s2">&quot;record[block=true]field(value)&quot;</span> <span class="o">-</span><span class="n">w</span> <span class="mi">100000000</span> <span class="n">PVRBusy</span> <span class="n">Acquire</span>
</pre></div>
</div>
<p>Another client can set it done:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">pvput</span> <span class="n">PVRBusy</span> <span class="n">Done</span>
</pre></div>
</div>
<p><strong>Notes</strong></p>
<ol class="arabic simple">
<li>The example only allows one client at a time to set the record busy and wait for completion. It should be changed to allow multiple clients to wait for completion.</li>
<li>The example should also implement the methods for channelProcess, channelGet, and channelPutGet</li>
</ol>
</div>
<div class="section" id="implementation-of-proposal">
<h3>Implementation of Proposal<a class="headerlink" href="#implementation-of-proposal" title="Permalink to this headline">¶</a></h3>
<p>Java code for the proposed implementation is available at:</p>
<p>&lt;<a class="reference external" href="https://github.com/mrkraimer/pvDatabaseJava/tree/asynRecord">https://github.com/mrkraimer/pvDatabaseJava/tree/asynRecord</a>&gt;</p>
<p><strong>Note</strong> If proposal is accepted the changes must undergo more testing and must also be implemented in <strong>pvDatabaseCPP</strong>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Proposal: Asynchronous PVRecord</a><ul>
<li><a class="reference internal" href="#proposal-summary">Proposal Summary</a></li>
<li><a class="reference internal" href="#epics-v4-background">EPICS V4 Background</a><ul>
<li><a class="reference internal" href="#pvdata">pvData</a><ul>
<li><a class="reference internal" href="#pvdata-pvstructure">pvData: PVStructure</a></li>
<li><a class="reference internal" href="#pvdata-bitset">pvData: BitSet</a></li>
<li><a class="reference internal" href="#pvdata-pvcopy">pvData: PVCopy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pvaccess">pvAccess</a></li>
<li><a class="reference internal" href="#pvdatabase">pvDatabase</a></li>
<li><a class="reference internal" href="#pvrecord-processing">PVRecord processing</a></li>
<li><a class="reference internal" href="#synchronous-processing">Synchronous Processing</a></li>
<li><a class="reference internal" href="#asynchronous-processing">Asynchronous Processing</a><ul>
<li><a class="reference internal" href="#channelprocess">ChannelProcess</a></li>
<li><a class="reference internal" href="#channelget">ChannelGet</a></li>
<li><a class="reference internal" href="#channelput">ChannelPut</a></li>
<li><a class="reference internal" href="#channelputget">ChannelPutGet</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pvcopy-record-options">PVCopy: record options</a><ul>
<li><a class="reference internal" href="#block">block</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-busy-record">Example: Busy Record</a></li>
<li><a class="reference internal" href="#implementation-of-proposal">Implementation of Proposal</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Welcome to Proposal For asynchronous PVRecord&#8217;s documentation!</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/asynRecord.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="index.html" title="Welcome to Proposal For asynchronous PVRecord’s documentation!"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Proposal For asynchronous PVRecord .1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Marty Kraimer.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
  </body>
</html>